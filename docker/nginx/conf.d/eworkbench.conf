# docker/nginx/conf.d/eworkbench.conf
#
# Single vhost file for the app nginx container.
# - HTTP is enabled by default (good for local testing).
# - HTTPS is included below as a commented block; enable by uncommenting and mounting certs.
#
# Goals:
# - Transparent reverse proxy to Next.js (web:3000)
# - Preserve forwarded headers (safe behind a future "master proxy")
# - SSE-safe for /api/sync/events (no buffering, no gzip)

# -----------------------------
# HTTP
# -----------------------------
server {
  listen 80;
  server_name _;

  # nginx default (often 1m) can break sync writes; match app intent (default 32 MiB).
  client_max_body_size 32m;

  # Optional health endpoint for container checks.
  location = /nginx-health {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # ---- SSE (real-time sync notifications) ----
  location = /api/sync/events {
    # Use a variable so nginx can re-resolve Docker DNS names on restart.
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    # Preserve external request context (important for NextAuth + middleware).
    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    # SSE must not be buffered, or the browser won't receive events promptly.
    proxy_buffering off;
    proxy_cache off;

    # Avoid response transformation interfering with event-stream framing.
    gzip off;
    proxy_set_header Accept-Encoding "";

    # Allow long reads; server pings + TTL close handle connection lifecycle.
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;

    # Keep upstream reusable (avoid forced 'Connection: close').
    proxy_set_header Connection "";
  }

  # ---- Everything else (Pages + APIs + streaming responses) ----
  location / {
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    # WebSocket-safe (harmless if unused).
    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $ew_connection_hdr;

    # Allow long-lived streaming responses.
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
  }
}

# -----------------------------
# HTTPS
# -----------------------------

server {
  listen 443 ssl;
  server_name _;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/privkey.pem;

  client_max_body_size 32m;

  location = /api/sync/events {
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    proxy_buffering off;
    proxy_cache off;

    gzip off;
    proxy_set_header Accept-Encoding "";

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;

    proxy_set_header Connection "";
  }

  location / {
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $ew_connection_hdr;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
  }
}