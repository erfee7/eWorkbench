# docker/nginx/conf.d/eworkbench.conf
#
# Two deployment modes. Keep ONE mode enabled at a time.
#
# MODE 1 (HTTP-only): local dev or behind an external TLS terminator.
# MODE 2 (HTTPS): nginx terminates TLS for this app; HTTP(80) redirects to HTTPS(443).
#
# Notes:
# - Transparent proxy (no rewrites, no caching).
# - SSE-safe for /api/sync/events (no buffering, no gzip).
# - X-Forwarded-* headers are preserved via $ew_forwarded_* maps in nginx.conf.

# # =============================================================================
# # MODE 1: HTTP-ONLY (ENABLED by default)
# # =============================================================================
# server {
#   listen 80;
#   server_name _;

#   # nginx default (often 1m) can break sync writes; match app intent (default 32 MiB).
#   client_max_body_size 32m;

#   location = /nginx-health {
#     add_header Content-Type text/plain;
#     return 200 'ok';
#   }

#   # ---- SSE (real-time sync notifications) ----
#   location = /api/sync/events {
#     set $ew_upstream http://web:3000;
#     proxy_pass $ew_upstream;

#     proxy_http_version 1.1;

#     proxy_set_header Host               $ew_forwarded_host;
#     proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
#     proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
#     proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
#     proxy_set_header X-Real-IP          $remote_addr;

#     proxy_buffering off;
#     proxy_cache off;

#     gzip off;
#     proxy_set_header Accept-Encoding "";

#     proxy_read_timeout 300s;
#     proxy_send_timeout 300s;

#     proxy_set_header Connection "";
#   }

#   # ---- Everything else ----
#   location / {
#     set $ew_upstream http://web:3000;
#     proxy_pass $ew_upstream;

#     proxy_http_version 1.1;

#     proxy_set_header Host               $ew_forwarded_host;
#     proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
#     proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
#     proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
#     proxy_set_header X-Real-IP          $remote_addr;

#     proxy_set_header Upgrade    $http_upgrade;
#     proxy_set_header Connection $ew_connection_hdr;

#     proxy_read_timeout 3600s;
#     proxy_send_timeout 3600s;
#   }
# }

# =============================================================================
# MODE 2: HTTPS (DISABLED TEMPLATE)
#
# To enable HTTPS mode:
# 1) Comment OUT the entire MODE 1 server block above.
# 2) Uncomment BOTH server blocks below (the :80 redirect and the :443 TLS server).
# 3) Mount certs to (as in docker-compose.yaml):
#      /etc/nginx/certs/fullchain.pem
#      /etc/nginx/certs/privkey.pem
# 4) Set NEXTAUTH_URL to your public https URL.
# =============================================================================

# --- HTTP -> HTTPS redirect ---
server {
  listen 80;
  server_name _;

#   # Production (standard ports):
#   return 301 https://$host$request_uri;

  # Local test with nonstandard published HTTPS port (e.g. 3443):
  return 301 https://$host:3443$request_uri;
}

# --- HTTPS reverse proxy ---
server {
  listen 443 ssl;
  server_name _;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/privkey.pem;

  client_max_body_size 32m;

  location = /nginx-health {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  location = /api/sync/events {
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    proxy_buffering off;
    proxy_cache off;

    gzip off;
    proxy_set_header Accept-Encoding "";

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;

    proxy_set_header Connection "";
  }

  location / {
    set $ew_upstream http://web:3000;
    proxy_pass $ew_upstream;

    proxy_http_version 1.1;

    proxy_set_header Host               $ew_forwarded_host;
    proxy_set_header X-Forwarded-Host   $ew_forwarded_host;
    proxy_set_header X-Forwarded-Proto  $ew_forwarded_proto;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP          $remote_addr;

    proxy_set_header Upgrade    $http_upgrade;
    proxy_set_header Connection $ew_connection_hdr;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
  }
}