# docker/nginx/nginx.conf
#
# Goal: transparent reverse proxy in front of Next.js.
# - Do not cache or rewrite.
# - Preserve Host/proto so NextAuth + middleware see correct external context.
# - Be SSE-safe (per-location config handles buffering).

worker_processes auto;

events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log warn;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  # Allows nginx to re-resolve Docker DNS names (helpful if containers restart).
  # 127.0.0.11 is Docker's embedded DNS server.
  resolver 127.0.0.11 valid=30s ipv6=off;

  # If an upstream proxy already set X-Forwarded-Proto, preserve it.
  # Otherwise fall back to what nginx sees.
  map $http_x_forwarded_proto $ew_forwarded_proto {
    default $http_x_forwarded_proto;
    ''      $scheme;
  }

  # Preserve the incoming Host including port (e.g. "localhost:3000").
  # This avoids subtle behavior changes vs direct-to-Next access.
  map $http_x_forwarded_host $ew_forwarded_host {
    default $http_x_forwarded_host;
    ''      $http_host;
  }

  # WebSocket-safe Connection header mapping (no-op for normal HTTP/SSE).
  map $http_upgrade $ew_connection_hdr {
    default upgrade;
    ''      '';
  }

  # Keep configs split into conf.d.
  include /etc/nginx/conf.d/*.conf;
}